From 0325c7bf4cee6b9a8ef061a7fff04051aab8a42e Mon Sep 17 00:00:00 2001
From: Sven Peter <sven@svenpeter.dev>
Date: Thu, 19 Aug 2021 17:38:32 +0200
Subject: [PATCH 17/40] nvme: add NVME_QUIRK_NO_SCAN_NS_LIST

Signed-off-by: Sven Peter <sven@svenpeter.dev>
---
 drivers/nvme/host/core.c | 2 ++
 drivers/nvme/host/nvme.h | 7 +++++++
 2 files changed, 9 insertions(+)

diff --git a/drivers/nvme/host/core.c b/drivers/nvme/host/core.c
index 4b5de8f5435a..3d95d863c2b5 100644
--- a/drivers/nvme/host/core.c
+++ b/drivers/nvme/host/core.c
@@ -4027,6 +4027,8 @@ static int nvme_scan_ns_list(struct nvme_ctrl *ctrl)
 	u32 prev = 0;
 	int ret = 0, i;
 
+	if (ctrl->quirks & NVME_QUIRK_NO_SCAN_NS_LIST)
+		return -EOPNOTSUPP;
 	if (nvme_ctrl_limited_cns(ctrl))
 		return -EOPNOTSUPP;
 
diff --git a/drivers/nvme/host/nvme.h b/drivers/nvme/host/nvme.h
index b334af8aa264..c9268742902b 100644
--- a/drivers/nvme/host/nvme.h
+++ b/drivers/nvme/host/nvme.h
@@ -144,6 +144,13 @@ enum nvme_quirks {
 	 * encoding the generation sequence number.
 	 */
 	NVME_QUIRK_SKIP_CID_GEN			= (1 << 17),
+
+	/*
+	 * The controller does not properly handle SCAN NS LIST
+	 * commands.
+	 */
+	NVME_QUIRK_NO_SCAN_NS_LIST		= (1 << 18),
+
 };
 
 /*
-- 
2.33.1

