# Maintainer: Luke Eversfield <lukeversfield111@gmail.com>

readonly pkgbase=linux-asahi-4k
readonly _desc="AArch64 Apple Silicon (M1 development 4k pagesize kernel)"

# needed since they would be overwritten
source ../linux-asahi/PKGBUILD

# add patch
source+=(https://raw.githubusercontent.com/tpwrules/nixos-m1/b8f6e63dbdd98954c6c9e87b7a619a2b490b512a/nix/m1-support/kernel/sven-iommu-4k.patch)
sha256sums+=('8db24e8bc5da49047b7a4d31f0c0b13b6621e6b85cf586dc9f70f5ec33533342')
b2sums+=('74a7e93f3d2502f2858c6a8b570cc6f214d37efb603d973e375440f5aa309596b4244cafb3e257805b442d2e2cdbd5badc89e645d517a9bb5224b75fee8ab672')

prepare() {
  cd $_srcname

  echo "Setting version..."
  # modify "version", otherwise conflicting with default kernel
  echo "-$_asahirel-$pkgrel-4K" > localversion.10-pkgrel

  local src
  for src in "${source[@]}"; do
    src="${src%%::*}"
    src="${src##*/}"
    [[ $src = *.patch ]] || continue
    echo "Applying patch $src..."
    patch -Np1 < "../$src"
  done

  echo "Setting config..."
  cp ../config .config
  # set 4K_PAGES config 
  sed -i -e 's/CONFIG_ARM64_4K_PAGES=n/CONFIG_ARM64_4K_PAGES=y/g' -e 's/CONFIG_ARM64_16K_PAGES=y/CONFIG_ARM64_16K_PAGES=n/g' .config
  make olddefconfig
  diff -u ../config .config || :

  make -s kernelrelease > version
  echo "Prepared $pkgbase version $(<version)"
}
